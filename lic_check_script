#!/bin/bash
# 用法: ./parse_lmstat.sh lmstat.log
# 输出 CSV，不包含 "floating license" 行

logfile="$1"

awk '
BEGIN {
    print "Feature,User,Host,Display,Version,LicServer,Port,SessionID,StartTime,Expiry"
}

# 捕获 Feature 名
/^Users of / {
    feature=$3
    sub(":", "", feature)
    expiry=""
}

# 捕获 expiry 信息
/^  "[^"]+"/ {
    # 排除 floating license 行
    if ($0 !~ /floating license/) {
        match($0, /expiry:[ \t]*([0-9a-zA-Z-]+)/, m)
        if (m[1] != "") {
            expiry=m[1]
        }
    }
}

# 捕获用户行（排除 "floating license"）
/^[ \t]+[a-zA-Z0-9._-]+[ \t]+[a-zA-Z0-9._-]+[ \t]+[a-zA-Z0-9.:_-]+[ \t]+[a-zA-Z0-9._-]+[ \t]*\(/ {
    if ($0 !~ /floating license/) {
        user=$1
        host=$2
        display=$3
        sessionid=$4

        # version
        match($0, /\(v[0-9.]+\)/)
        ver=substr($0, RSTART+1, RLENGTH-2)

        # server/port & sid
        match($0, /\(([a-zA-Z0-9._-]+)\/([0-9]+) *([0-9]+)\)/, m)
        licserver=m[1]
        port=m[2]
        sid=m[3]

        # start time
        match($0, /start .*/, m2)
        start=m2[0]
        sub("start ", "", start)

        printf("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s\n",
               feature, user, host, display, ver, licserver, port, sessionid, start, expiry)
    }
}
' "$logfile"
