#!/bin/bash
# parse_lmstat_to_sql_enhanced.sh
# 用法: ./parse_lmstat_to_sql_enhanced.sh lmstat.log > licenses.sql

logfile="$1"

awk '
BEGIN {
    FS=""
    feature=""
    user=""
    host=""
    version=""
    licserver=""
    port=""
    session=""
    starttime=""
    expiry=""
    print "BEGIN TRANSACTION;"
}

# 提取 License Server 和 Port
/^License server status:/ {
    split($0,a,":")
    split(a[2],b,"@")
    if(length(b)==2){
        licserver=b[2]
        port=b[1]
    } else {
        licserver=a[2]
        port=""
    }
}

# 提取 Feature 名称
/^Users of / {
    feature=$3
    sub("[:]", "", feature)
}

# 提取 Expiry 和 Version（Cadence/Synopsys/Mentor 格式）
/^  "[^"]+"/ {
    if ($0 ~ /expiry:/) {
        match($0, /expiry: ([^ ]+)/, m)
        expiry=m[1]
        # 提取 Version
        if(match($0, /v[0-9.]+/, ver)) version=ver[0]
    }
}

# 提取用户占用信息（多厂商兼容）
/^[ \t]+[a-zA-Z0-9_-]+[ \t]+[a-zA-Z0-9_.:-]+[ \t]*(:[0-9]+)?[ \t]*\(v[0-9.]+/ {
    line=$0
    # User
    match(line, /^[ \t]*([a-zA-Z0-9_-]+)/, u)
    user=u[1]
    # Host
    match(line, /[ \t]+([a-zA-Z0-9_.-]+(:[0-9]+)?)/, h)
    host=h[1]
    # Version
    match(line, /\(v([0-9.]+)/, v)
    version=v[1]
    # Session ID
    match(line, /\([^)]+\)$/, s)
    session=s[0]; gsub("[()]", "", session)
    # StartTime
    starttime=""
    if(match(line, /start[ \t]+[^)]*/, t)) starttime=substr(line, RSTART+6, RLENGTH-6)
    
    # SQL 转义
    gsub("'\''", "''", feature)
    gsub("'\''", "''", user)
    gsub("'\''", "''", host)
    gsub("'\''", "''", version)
    gsub("'\''", "''", licserver)
    gsub("'\''", "''", port)
    gsub("'\''", "''", session)
    gsub("'\''", "''", starttime)
    gsub("'\''", "''", expiry)

    printf "INSERT INTO licenses (Feature, User, Host, Version, LicServer, Port, SessionID, StartTime, Expiry) VALUES (\x27%s\x27, \x27%s\x27, \x27%s\x27, \x27%s\x27, \x27%s\x27, \x27%s\x27, \x27%s\x27, \x27%s\x27, \x27%s\x27);\n", feature, user, host, version, licserver, port, session, starttime, expiry
}

END {
    print "COMMIT;"
}
' "$logfile"
