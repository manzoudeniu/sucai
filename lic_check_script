#!/bin/bash
# parse_lmstat_to_sql.sh
# 用法: ./parse_lmstat_to_sql.sh lmstat.log licenses.sql
# 支持 Mentor / Synopsys / Cadence
# 生成 SQL 文件，可直接导入 MySQL

logfile="$1"
sqlfile="$2"

echo "USE licenseDB;" > "$sqlfile"
echo "INSERT INTO licenses (Feature,User,Host,Version,LicServer,Port,SessionID,StartTime,Expiry) VALUES" >> "$sqlfile"

awk -v OFS="," '
BEGIN { first=1 }

/^Users of / {
    feature=$3
    sub(":", "", feature)
    expiry=""
}

/^  "[^"]+"/ {
    if ($0 !~ /floating license/) {
        match($0, /expiry:[ \t]*([0-9a-zA-Z-]+)/, m)
        if (m[1] != "") expiry=m[1]
    }
}

/Total of [0-9]+ licenses issued/ { next }
NF==0 { next }
/queued/ { next }

/^\s*[a-zA-Z0-9]/ {
    if ($0 !~ /floating license/ && $0 !~ /Display/) {
        line=$0

        match(line, /^[ \t]*([^\t ,]+)/, m)
        user=m[1]
        sub(/^[ \t]*[^\t ,]+[ \t]+/, "", line)

        host=""
        if (match(line, /^([^\t ()]+)/, m2)) host=m2[1]

        ver=""
        if (match($0, /\(v[0-9.]+\)/)) ver=substr($0, RSTART+2, RLENGTH-3)

        licserver=""
        port=""
        sid=""
        if (match($0, /\(([a-zA-Z0-9._-]+)\/([0-9]+) *([0-9]+)\)/, m3)) {
            licserver=m3[1]
            port=m3[2]
            sid=m3[3]
        }

        start=""
        if (match($0, /start .*/, m4)) {
            start=m4[0]
            sub("start ", "", start)
            gsub(/, [0-9]+ licenses$/, "", start)
        }

        # 生成 SQL
        vals="(\x27"feature"\x27,\x27"user"\x27,\x27"host"\x27,\x27"ver"\x27,\x27"licserver"\x27,"port","sid",\x27"start"\x27,\x27"expiry"\x27)"
        if (first==1) { print "  " vals; first=0 }
        else { print " , " vals }
    }
}
' "$logfile" >> "$sqlfile"

echo ";" >> "$sqlfile"
echo "SQL 文件已生成: $sqlfile"
